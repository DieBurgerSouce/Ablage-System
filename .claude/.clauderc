### OCR-Backend-Auswahl-Matrix
| Dokumenttyp | Engine | Grund |
|-------------|--------|-------|
| Komplexe Rechnungen | DeepSeek-Janus-Pro 7B | H√∂chste Genauigkeit f√ºr Tabellen |
| Standard-Formulare | GOT-OCR 2.0 | Benchmark-Zuverl√§ssigkeit |
| Technische Dokumentation | Surya + Docling | Layout-Erhaltung |
| Handschrift | DeepSeek-Janus-Pro | Beste Robustheit |

## Entwicklungsstandards

### Code-Konventionen
- **Python**: PEP 8, Type Hints erforderlich, Black Formatter
- **Docstrings**: Google-Stil, vollst√§ndig f√ºr √∂ffentliche APIs
- **Testing**: pytest, Mindestabdeckung 85%
- **Logging**: Strukturiertes Logging (JSON), keine PII in Logs

### Git-Workflow
- **Branching**: GitFlow (main/develop/feature/hotfix)
- **Commits**: Conventional Commits (feat/fix/docs/refactor)
- **Reviews**: Mindestens 1 Approval vor Merge
- **CI/CD**: Automatische Tests + Linting vor Deployment

### Sicherheitsstandards
- **Secrets**: Niemals im Code, nur Umgebungsvariablen
- **API-Keys**: AWS Secrets Manager / HashiCorp Vault
- **Verschl√ºsselung**: TLS 1.3 (Transit), AES-256 (Ruhe) 
- **Audit**: Alle Dokumentenzugriffe geloggt
- **DSGVO**: 30-Tage-Retention, Anonymisierung vor Verarbeitung

## Deutsche Sprachverarbeitung

### Besonderheiten
- **Encoding**: UTF-8 obligatorisch (√§, √∂, √º, √ü-Unterst√ºtzung)
- **Rechtschreibung**: Neue deutsche Rechtschreibung
- **Regionale Varianten**: 
  - Deutschland (Standard)
  - Schweiz (ss statt √ü)
  - √ñsterreich (Besonderheiten dokumentiert)
- **Frakturschrift**: Historische Dokumente (1600-1938) 
- **Zusammengesetzte W√∂rter**: Tokenisierung ber√ºcksichtigt Compounds

### OCR-Qualit√§tsstandards
- **Mindestgenauigkeit**: 95% f√ºr finanzielle Dokumente
- **Konfidenzwerte**: Bei <0.90 manuelle Pr√ºfung
- **Validierung**: Checksummen, Plausibilit√§tspr√ºfungen
- **Fehlerbehandlung**: Automatisches Retry mit alternativer Engine

## GPU-Optimierung (RTX 4080)

### CUDA-Konfiguration
```python
# Umgebungsvariablen
CUDA_VISIBLE_DEVICES=0
PYTORCH_CUDA_ALLOC_CONF=max_split_size_mb:512
CUDA_LAUNCH_BLOCKING=0  # Async f√ºr Performance

# GPU-Speicherverwaltung
gpu_memory_utilization=0.85  # 85% von 16GB = 13.6GB
max_batch_size=16  # Abh√§ngig von Dokumentgr√∂√üe
```

### Performance-Targets
- **Durchsatz**: 100+ Seiten/Minute (Standard-Dokumente)
- **Latenz**: <500ms pro Seite (einfache Dokumente)
- **GPU-Auslastung**: 70-90% (optimaler Bereich)
- **Warteschlange**: Max. 1000 Dokumente

### Monitoring
- **Metriken**: GPU-Auslastung, VRAM, Temperatur, Leistung
- **Alerts**: >85¬∞C, >95% VRAM, <50% Auslastung (Underutilization)
- **Tools**: nvidia-smi, nvtop, Prometheus nvidia_gpu_exporter

## Befehle

### Entwicklung
```bash
# Umgebung einrichten
conda create -n ablage python=3.11
conda activate ablage
pip install -r requirements.txt

# Tests ausf√ºhren
pytest tests/ -v --cov=src --cov-report=html

# Linting
black src/ tests/
isort src/ tests/
flake8 src/ tests/
mypy src/

# Lokale Entwicklung
docker-compose up -d
python src/main.py --dev
```

### Produktion
```bash
# Deployment (Terraform + Ansible)
cd infrastructure/
terraform plan -out=tfplan
terraform apply tfplan

cd ../ansible/
ansible-playbook -i production deploy.yml

# Monitoring
kubectl get pods -n ablage-system
kubectl logs -f deployment/ocr-worker

# Health Check
curl https://api.ablage-system.internal/health
```

### OCR-Pipeline
```bash
# Einzelnes Dokument verarbeiten
python cli.py process --input scan.pdf --output result.json --engine deepseeek-janus-pro

# Batch-Verarbeitung
python cli.py batch --input-dir ./scans/ --output-dir ./results/ --workers 4

# Qualit√§tspr√ºfung
python cli.py validate --input result.json --threshold 0.95
```

## Kritische Regeln (NIEMALS)

### Sicherheit
- ‚ùå API-Keys oder Secrets im Code committen
- ‚ùå PII (personenbezogene Daten) in Logs schreiben
- ‚ùå Unverschl√ºsselte Dokumente speichern
- ‚ùå Produktionsdatenbank von Entwicklungsmaschine zugreifen
- ‚ùå `sudo` in Deployment-Skripten (Container verwenden)

### Code-Qualit√§t
- ‚ùå Code ohne Tests committen (85% Coverage Minimum)
- ‚ùå Type Hints weglassen in √∂ffentlichen APIs
- ‚ùå Hardcodierte Pfade oder URLs
- ‚ùå Global State oder Singleton-Pattern missbrauchen
- ‚ùå Undokumentierte Breaking Changes

### GPU-Verarbeitung
- ‚ùå Synchrone Blocking-Calls (async/await verwenden)
- ‚ùå GPU-Speicher nicht freigeben (torch.cuda.empty_cache())
- ‚ùå Gro√üe Batches ohne Memory-Check (OOM-Risiko)
- ‚ùå CPU-Operationen auf GPU-Daten (Overhead)

## DSGVO-Konformit√§t

### Datenverarbeitung
1. **Einwilligung**: Vor Verarbeitung verifizieren (`verify_consent.py`)
2. **Anonymisierung**: PII-Erkennung + Entfernung (`anonymize_pii.py`)
3. **Verarbeitung**: Nur anonymisierte Daten an Claude/OCR
4. **Verschl√ºsselung**: Output verschl√ºsseln (`encrypt_output.py`)
5. **Audit**: Vollst√§ndiger Trail in GDPR-konformen Logs

### Retention-Policy
- **Rohdokumente**: 7 Tage (verschl√ºsselt)
- **Verarbeitete Daten**: 30 Tage (verschl√ºsselt) 
- **Audit-Logs**: 6 Jahre (rechtliche Anforderung)
- **Automatische L√∂schung**: Cronjob t√§glich 02:00 UTC

### Technische Ma√ünahmen
- **Verschl√ºsselung at Rest**: AES-256-GCM
- **Verschl√ºsselung in Transit**: TLS 1.3 
- **Zugriffskontrolle**: RBAC mit Audit-Trail
- **Pseudonymisierung**: UUIDs statt Namen
- **Recht auf L√∂schung**: Implementiert via API

## Dokumentation

### Pflichtdokumentation
- **ARCHITECTURE.md**: Systemdesign, Komponenten, Datenfl√ºsse
- **DEPLOYMENT.md**: Infrastructure-as-Code, Deployment-Prozess
- **CONVENTIONS.md**: Code-Standards, Namenskonventionen
- **FRONTEND.md**: UI/UX-Richtlinien, Komponenten
- **CLAUDE.md** (dieses Dokument): Claude-spezifische Anweisungen

### API-Dokumentation
- **OpenAPI Spec**: Automatisch generiert aus FastAPI
- **Zugriff**: `/docs` (Swagger UI), `/redoc` (ReDoc)
- **Versionierung**: Semantic Versioning (v1, v2)

## Fehlerbehandlung

### OCR-Fehler
- **Confidence <0.95**: Automatisches Retry mit alternativer Engine
- **Complete Failure**: Manuelle Pr√ºfung-Queue + Benachrichtigung
- **Timeout**: Nach 60s abbrechen, in Retry-Queue

### GPU-Fehler
- **OOM (Out of Memory)**: Batch-Size reduzieren, Cache leeren
- **CUDA Error**: Fallback auf CPU, Alert senden
- **√úberhitzung**: Throttling aktivieren, Admins benachrichtigen

### System-Fehler
- **Disk Full**: Automatische Cleanup-Routine, Alert
- **Network Error**: Exponential Backoff (1s, 5s, 30s)
- **DB Connection**: Connection Pool Retry, Circuit Breaker

## Performance-Optimierung

### Caching-Strategie
- **Redis**: OCR-Ergebnisse (1 Stunde TTL)
- **CDN**: Statische Assets (Frontend)
- **Database Query Cache**: H√§ufige Abfragen (15 Min)

### Skalierung
- **Horizontal**: Mehrere Worker-Instanzen
- **Vertikal**: GPU-Ressourcen nach Bedarf
- **Load Balancing**: NGINX mit Least-Connections
- **Auto-Scaling**: Basierend auf Warteschlangenl√§nge

## Kontextgrenzen

### Dateien bearbeiten
- ‚úÖ `src/` - Application Code
- ‚úÖ `tests/` - Test Suites
- ‚úÖ `docs/` - Dokumentation
- ‚úÖ `scripts/` - Utility Scripts
- ‚úÖ `infrastructure/` - IaC (mit Vorsicht)

### Dateien NUR lesen
- üìñ `config/` - Konfigurationsdateien
- üìñ `.env.example` - Umgebungsvariablen-Template
- üìñ `requirements.txt` - Dependencies

### Dateien NIEMALS anfassen
- üö´ `.env` - Aktuelle Secrets
- üö´ `venv/`, `__pycache__/`, `.pytest_cache/` - Build-Artefakte
- üö´ `.git/` - Git-Interna
- üö´ `data/` - Rohdokumente (DSGVO)
- üö´ `secrets/` - Verschl√ºsselte Credentials

## Team-Kommunikation

### Code Reviews
- **Checkliste**: Tests, Docs, Security, Performance
- **Timeframe**: 24 Stunden Response-Zeit
- **Approval**: Mindestens 1 Senior-Entwickler

### Incident Response
1. **Erkennung**: Monitoring-Alert
2. **Eskalation**: On-Call Engineer
3. **Mitigation**: Sofortige Ma√ünahmen
4. **Post-Mortem**: Innerhalb 72 Stunden
5. **Follow-up**: Pr√§ventive Ma√ünahmen

## Debugging

### Logging-Level
- **Production**: INFO (strukturiert als JSON)
- **Staging**: DEBUG (mit Context)
- **Development**: DEBUG + Verbose

### Debugging-Tools
```bash
# GPU-Debugging
nvidia-smi dmon -s pucvmet -i 0
nvtop

# Application-Debugging
python -m pdb src/main.py
PYTHONBREAKPOINT=ipdb.set_trace python src/main.py

# Performance-Profiling
python -m cProfile -o profile.stats src/main.py
snakeviz profile.stats
```

## Weitere Ressourcen

- **Confluence**: Detaillierte Design-Docs
- **Jira**: Sprint-Planning, Tickets
- **Slack**: #ablage-system, #ocr-engineering
- **GitHub**: Issues, Discussions, Wiki